---
title: "Assignment 2"
author: "Emanuele Coradin"
date: "2024-04-16"
output: 
  read_document: rmdformats::readthedown
  html_document:
    number_sections: true
    theme: spacelab
  pdf_document:
    number_sections: true
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

color_vector <- c("#CC0000",   # Dark red
                  "#CC79A7",   # Muted purple
                  "#D55E00",   # Vermilion
                  "#009E73",   # Bluish green
                  "#56B4E9",   # Sky blue
                  '#000046',   # Deep Blue
                  "#DB1E60",   # Pinkish-red
                  "#E69F00")   # Yellow-orange

```

```{r, message=FALSE, echo=FALSE}
library(dplyr)
library(ggplot2)
```

# Exercise 1: Discrete random variable

1. Write the R functions for the probability density and cumulative distribution functions, using the R naming convention.
2. Produce two plots showing the pdf and cdf, separately.
3. Compute the mean value and variance of the probability distribution using R. 4. Generate a sample of random numbers from this distribution and show them in an histogram. Evaluate the sample mean.

```{r 1.1}
# Parameters for the poisson distribution
lambda_vec <- c(1.4,4,6, 8)
k <- 1:13


integrate_step <- function(f, lower, upper){
  integral = 0
  for(x in lower:(upper-1))
    integral = integral+f(x)
  return(integral)
}

dzeropois <- function(k, lambda){
  #to handle float numbers
  k = trunc(k)
  return(lambda^k*exp(-lambda)/factorial(k)/(1-exp(-lambda)))
}

#designed to handle vectors of q in input
pzeropois <- function(q, lambda) {
  #to handle float numbers
  q = as.integer(trunc(q))
  P_cum <- numeric(length(q))
  for (i in 1:length(q)) {
    k <- 1:q[i]
    P_cum[i] <- sum(dzeropois(k, lambda))
  }
  return(P_cum)
}

# Function used to invert the pzeropois
threshold_search <- function(f, guess, threshold, lambda) {
  x <- as.integer(trunc(guess))
  while(TRUE) {
    if(f(x, lambda) - threshold <= 0) {
      if(f(x + 1, lambda) - threshold >= 0)
        return(x+1)
      else 
        x <- x + 1
    } 
    else if(x>1)
      x <- x - 1
    else
      return(x)
  }
}

# Function to generate random samples from Poisson distribution
rzeropois <- function(n, lambda) {
  p <- runif(n, min = 1e-10, max = 1-1e-10)
  x <- sapply(p, function(probability) {
    threshold_search(pzeropois, lambda+1, probability, lambda)
  })
  return(x)
}


poisson_pdf <- sapply(lambda_vec, function(L) {dzeropois(k, L)})
poisson_cum <- sapply(lambda_vec, function(L) {pzeropois(k, L)})

linetype <- 2-(1:length(lambda_vec))%%2
```

```{r 1.2}
# create the first straight line plot
plot(k,poisson_pdf[,1], type = "s", lwd = 2, col = color_vector[1], 
     xlab = "k", ylab = "PDF", lty = linetype[1])

# create all the others
for (i in 2:length(lambda_vec)) {
  lines(k, poisson_pdf[, i], col=color_vector[i], type='s', lwd=2, lty = linetype[i])

}

grid()

# Create legend labels
legend_labels <- paste('lambda = ', lambda_vec)
# Add a legend
legend("topright", legend = legend_labels, col = color_vector[1:length(lambda_vec)], lty = linetype, lwd = 2)
# Add a title
title("Theoretical zero-truncated Poisson Distribution")
```
```{r 1.2}
# create the first straight line plot
plot(k,poisson_cum[,1], type = "s", lwd = 2, col = color_vector[1], 
     xlab = "k", ylab = "P", lty = linetype[1], ylim=c(0,1))

# create all the others
for (i in 2:length(lambda_vec)) {
  lines(k, poisson_cum[, i], col=color_vector[i], type='s', lwd=2, lty = linetype[i], ylim=c(0,1))

}

grid()

# Create legend labels
legend_labels <- paste('lambda = ', lambda_vec)
legend("bottomright", legend = legend_labels, col = color_vector[1:length(lambda_vec)], lty = linetype, lwd = 2)

title("Theoretical zero-truncated Poisson Cumulative Distribution")
```

```{r 1.3}
lambda = 1.4
mean = integrate_step(function(x){x*dzeropois(x,lambda)}, lower = 1, upper = 15)
std  = integrate_step(function(x){x^2*dzeropois(x,lambda)}, lower = 1, upper = 15)

writeLines(sprintf(
"
Taking lambda = 1.4 and truncating the sum at k=15 we can obtain:
  - The mean value is %.2f
  - The standard deviation is %.2f
",
  mean[1], std[1])
)
```
```{r 1.4}
n = 1000
random_numbers <- rzeropois(n, lambda)

breaks <- seq(1 - 0.5, 10 + 0.5, by = 1)
#plot
hist(random_numbers, breaks=breaks, col = color_vector[5], xlab = "x", ylab = "Density", freq = FALSE, main="")
lines(k-0.5, poisson_pdf[,1], type='s', lwd = 2, col = color_vector[1], lty = linetype[1])

legend_labels <- paste('True distribution')
legend("topright", legend = legend_labels, col = color_vector[1], lty = linetype[1], lwd = 2)

grid()
title("Distribution of generated random numbers")
```

# Exercise 2: Continuous random variable

* Considering the energy distribution of CR muons at sea level:
  1. Compute the normalization factor;
  2. Plot the probability density function in R. 
  3. Plot the cumulative density function in R. 
  4. Compute the mean value using R 
  5. [Optional] Generate 106 random numbers from this distribution, show them in an histogram and superimpose the pdf (with a line or with a sufficient number of points).
  
  
```{r 2.}
dmuonenergy <- function(E, N, E0, g){ ifelse(test = E<E0, yes = return(N), no = return(N*(E-E0+1)^(-g))) }
pmuonenergy <- function(q, N, E0, g){ return(integrate(function (x) {sapply(x, function(E) {dmuonenergy(E, N, E0, g) })}, lower = 0, upper = q)$value) }
normalize <- function(E0, g){ pmuonenergy(Inf, 1, E0, g)^-1 }
```
```{r 2.1}
E0 <- 7.25 #GeV
g  <- 2.7  #gamma factor

#Compute the normalization factor
N = normalize(E0, g)
print(sprintf("The normalization factor is %.2f", N))
```
```{r 2.2}
#Plotting the pdf
x_plot <- seq(from=0, to=13, length.out=50)
y_plot <- sapply(x_plot, function(E){dmuonenergy(E, N, E0, g)})

#plot
plot(x_plot, y_plot, type='l', lwd = 2, col = color_vector[1], lty = linetype[1], xlab="E [GeV]", ylab="PDF")


grid()
title(expression(paste("Muon energy pdf [E0" , " = 7.25GeV, ", gamma, " = 2.7]")))
```
```{r 2.3}
#Plotting the cumulative
x_plot <- seq(from=0, to=13, length.out=50)
y_plot <- sapply(x_plot, function(E){pmuonenergy(E, N, E0, g)})

#plot
plot(x_plot, y_plot, type='l', lwd = 2, col = color_vector[1], lty = linetype[1], xlab="E [GeV]", ylab="P")

grid()
title(expression(paste("Muon energy cdf [E0" , " = 7.25GeV, ", gamma, " = 2.7]")))
```


```{r 2.4}
#Comute the mean value
mean <- integrate(function(x){ sapply(x, function(E){ E * dmuonenergy(E, N, E0, g) }) }, lower = 0, upper = Inf)$value
sprintf("The mean value is %.2f", mean)
```


